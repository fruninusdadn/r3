name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., patch, minor, major, or specific version)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test --ignore-scripts || true
        continue-on-error: true

      - name: Bump version
        id: version
        run: |
          NEW_VERSION=$(npm version ${{ github.event.inputs.version }} --no-git-tag-version)
          echo "new_version=${NEW_VERSION#v}" >> $GITHUB_OUTPUT
          npm run sync-version
          git add package.json package-lock.json website/lib/version.ts
          git commit -m "chore(release): ${NEW_VERSION}

          - Intelligent memory layer for AI applications
          - Sub-5ms response times with Redis caching
          - Automatic failover to cloud storage
          - MCP server for Claude Desktop

          Co-Authored-By: GitHub Actions <actions@github.com>"

      - name: Push changes
        run: |
          git push origin main
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release v${{ steps.version.outputs.new_version }}"
          git push origin "v${{ steps.version.outputs.new_version }}"

      - name: Publish to npm
        run: npm publish --ignore-scripts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: v${{ steps.version.outputs.new_version }}
          generate_release_notes: true
          body: |
            ## ðŸš€ R3call v${{ steps.version.outputs.new_version }}

            Lightning-fast memory layer for AI applications with sub-5ms response times.

            ### ðŸ“¦ Installation
            ```bash
            npm install r3call@${{ steps.version.outputs.new_version }}
            ```

            ### ðŸ”§ Claude Desktop Setup
            ```bash
            npx r3call
            ```

            ### ðŸ“š Documentation
            - [Getting Started](https://r3call.newth.ai/docs/quickstart)
            - [API Reference](https://r3call.newth.ai/docs/api-reference)
            - [Examples](https://r3call.newth.ai/docs/examples)

            ### What's Changed
            See below for auto-generated changelog.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}